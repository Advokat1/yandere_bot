import aiohttp


class Parser:
    base_uri = 'https://danbooru.donmai.us'

    def __init__(self):
        self.session = aiohttp.ClientSession()

    async def get_list(self, page, limit=10, tags=None):
        if tags is None:
            tags = ['rating:q katai_kollection']
        uri = '/posts.json'
        params = {
            'limit': limit,
            'page': page,
            'tags': ' '.join(tags)
        }
        async with self.session.get(self.base_uri + uri, params=params) as response:
            json = await response.json()
            self.save(json)

    def save(self, array: list) -> bool:
        from models import Img

        for item in array:
            if not 'id' in item:
                continue
            img = Img()
            img.id = item['id']
            img.tags = item['tag_string'].split(' ')
            img.author = item['tag_string_artist']
            img.source = item['source']
            img.file_url = item['file_url']
            img.score = item['score']
            img.rating = item['rating']
            img.is_rating_locked = item['is_rating_locked']
            img.has_children = item['has_visible_children']
            img.save()
        return True


parser = Parser()
